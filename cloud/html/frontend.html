<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Ranjyaa-miband</title>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
  :root {
    --bg: #0e0e10;
    --surface: #18181b;
    --border: #27272a;
    --text: #e4e4e7;
    --text-dim: #71717a;
    --red: #ef4444;
    --green: #22c55e;
    --yellow: #eab308;
    --blue: #3b82f6;
    --font-mono: 'Courier New', 'Consolas', monospace;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-mono);
    font-size: 15px;
    height: 100vh;
    overflow: hidden;
    display: flex;
    justify-content: center;
    padding: 24px 16px;
  }
  .container {
    width: 100%;
    max-width: 720px;
    height: 100%;
    display: flex;
    flex-direction: column;
    gap: 16px;
    overflow: hidden;
    padding-bottom: env(safe-area-inset-bottom, 0px);
  }

  /* header */
  .header {
    display: flex;
    align-items: baseline;
    gap: 12px;
    flex-shrink: 0;
  }
  .header h1 {
    font-size: 16px;
    font-weight: 600;
    letter-spacing: 1px;
  }
  .dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--text-dim);
    display: inline-block;
  }
  .dot.live { background: var(--green); animation: pulse 1.5s infinite; }
  @keyframes pulse { 0%,100%{ opacity:1; } 50%{ opacity:.3; } }

  /* hr display */
  .hr-section {
    text-align: center;
    padding: 20px 0 8px;
    flex-shrink: 0;
  }
  .hr-value {
    font-size: 80px;
    font-weight: 700;
    line-height: 1;
    transition: transform .15s;
  }
  .hr-value.bump { transform: scale(1.04); }
  .hr-unit { font-size: 16px; color: var(--text-dim); margin-left: 4px; }
  .hr-zone {
    font-size: 13px;
    color: var(--text-dim);
    margin-top: 6px;
    letter-spacing: .5px;
  }

  /* current window */
  .window-bar {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 14px;
    font-size: 13px;
    color: var(--text-dim);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex-shrink: 0;
  }
  .window-bar span { color: var(--text); }

  /* chart */
  .chart-wrap {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px;
    flex-shrink: 0;
  }
  canvas { width: 100%; height: 140px; display: block; }

  /* stats */
  .stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    flex-shrink: 0;
  }
  .stat-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px;
    text-align: center;
  }
  .stat-label { font-size: 12px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }
  .stat-val { font-size: 28px; font-weight: 700; margin-top: 4px; }

  /* chat */
  .chat-section {
    display: flex;
    flex-direction: column;
    gap: 10px;
    flex: 1;
    min-height: 0;
    overflow: hidden;
  }
  .chat-section.has-messages {
    flex-direction: column;
  }
  .chat-input-row {
    display: flex;
    gap: 8px;
    order: -1;
  }
  .chat-section.has-messages .chat-input-row {
    order: 1;
  }
  .chat-input-row input {
    flex: 1;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    padding: 10px 14px;
    font-family: var(--font-mono);
    font-size: 14px;
    outline: none;
  }
  .chat-input-row input::placeholder { color: var(--text-dim); }
  .chat-input-row input:focus { border-color: var(--text-dim); }
  .chat-input-row button {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    padding: 10px 18px;
    font-family: var(--font-mono);
    font-size: 14px;
    cursor: pointer;
    white-space: nowrap;
  }
  .chat-input-row button:hover { border-color: var(--text-dim); }
  .chat-input-row button:disabled { opacity: .4; cursor: not-allowed; }

  .chat-messages {
    display: flex;
    flex-direction: column;
    gap: 10px;
    flex: 1;
    min-height: 0;
    overflow-y: auto;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px;
  }

  /* ç©ºçŠ¶æ€ */
  .chat-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex: 1;
    gap: 16px;
    padding: 20px;
  }
  .chat-empty-hint {
    font-size: 13px;
    color: var(--text-dim);
    letter-spacing: .5px;
  }
  .chat-quick-btns {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
  }
  .chat-quick-btn {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    color: var(--text-dim);
    padding: 6px 14px;
    font-family: var(--font-mono);
    font-size: 12px;
    cursor: pointer;
    transition: border-color .2s, color .2s;
  }
  .chat-quick-btn:hover {
    border-color: var(--text-dim);
    color: var(--text);
  }
  .chat-section.has-messages .chat-empty {
    display: none;
  }

  /* ç”¨æˆ·æ¶ˆæ¯ */
  .msg-user {
    align-self: flex-end;
    background: var(--border);
    border-radius: 8px;
    padding: 10px 14px;
    font-size: 14px;
    max-width: 85%;
    word-break: break-word;
  }

  /* agent æ¶ˆæ¯ç»„ */
  .msg-agent-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
    max-width: 90%;
  }

  /* æ€ç»´é“¾æ°”æ³¡ - å¯æŠ˜å  + åŠ¨ç”» */
  .msg-thinking {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 13px;
    color: var(--text-dim);
  }
  .msg-thinking summary {
    padding: 8px 12px;
    cursor: pointer;
    user-select: none;
    font-size: 12px;
    color: var(--text-dim);
    list-style: none;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .msg-thinking summary::before {
    content: 'â–¶';
    font-size: 10px;
    transition: transform .25s ease;
    display: inline-block;
  }
  .msg-thinking[open] summary::before {
    transform: rotate(90deg);
  }
  .msg-thinking .details-body {
    display: grid;
    grid-template-rows: 0fr;
    transition: grid-template-rows .3s ease;
    overflow: hidden;
  }
  .msg-thinking[open] .details-body {
    grid-template-rows: 1fr;
  }
  .msg-thinking .details-inner {
    min-height: 0;
    overflow: hidden;
  }
  .msg-thinking .thinking-content {
    padding: 0 12px 10px;
    line-height: 1.6;
    white-space: pre-wrap;
    word-break: break-word;
    border-top: 1px solid var(--border);
    padding-top: 8px;
    margin-top: 0;
  }

  /* å·¥å…·è°ƒç”¨æ°”æ³¡ - åµŒå…¥æ€ç»´é“¾å†…éƒ¨ + åŠ¨ç”» */
  .msg-tool {
    background: rgba(0,0,0,.25);
    border: 1px solid #2d3748;
    font-size: 13px;
    margin: 6px 12px 8px;
    border-radius: 6px;
  }
  .msg-tool summary {
    padding: 8px 12px;
    cursor: pointer;
    user-select: none;
    font-size: 12px;
    color: var(--blue);
    list-style: none;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .msg-tool summary::before {
    content: 'â–¶';
    font-size: 10px;
    transition: transform .25s ease;
    display: inline-block;
    color: var(--blue);
  }
  .msg-tool[open] summary::before {
    transform: rotate(90deg);
  }
  .msg-tool .details-body {
    display: grid;
    grid-template-rows: 0fr;
    transition: grid-template-rows .3s ease;
    overflow: hidden;
  }
  .msg-tool[open] .details-body {
    grid-template-rows: 1fr;
  }
  .msg-tool .details-inner {
    min-height: 0;
    overflow: hidden;
  }
  .msg-tool .tool-content {
    padding: 0 12px 10px;
    line-height: 1.5;
    white-space: pre-wrap;
    word-break: break-all;
    border-top: 1px solid #2d3748;
    padding-top: 8px;
    color: var(--text-dim);
    font-size: 12px;
    max-height: 200px;
    overflow-y: auto;
  }

  /* agent æœ€ç»ˆå›ç­”æ°”æ³¡ */
  .msg-answer {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 25px;
    font-size: 14px;
    line-height: 1.7;
    word-break: break-word;
  }

  /* loading */
  .msg-loading {
    font-size: 13px;
    color: var(--text-dim);
    padding: 8px 12px;
  }
  .msg-loading::after {
    content: '';
    animation: dots 1.2s steps(3,end) infinite;
  }
  @keyframes dots {
    0% { content: ''; }
    33% { content: '.'; }
    66% { content: '..'; }
    100% { content: '...'; }
  }

  /* footer */
  .footer { font-size: 11px; color: var(--text-dim); text-align: center; padding: 8px 0 24px; flex-shrink: 0; }

  /* scrollbar */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); }

  @media (max-width: 600px) {
    body { padding: 12px 8px 32px; font-size: 13px; }
    .hr-value { font-size: 48px; }
    .hr-section { padding: 10px 0 4px; }
    .stat-val { font-size: 20px; }
    .stat-box { padding: 8px; }
    .stats { gap: 8px; }
    .container { gap: 10px; }
    .chart-wrap { padding: 8px; }
    canvas { height: 100px !important; }
    .window-bar { padding: 8px 12px; font-size: 12px; }
    .chat-section { min-height: 200px; }
    .footer { padding-bottom: 32px; }
  }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <span class="dot" id="dot"></span>
    <span style="font-size:12px;color:var(--text-dim)" id="status">offline</span>
  </div>

  <div class="hr-section">
    <span class="hr-value" id="hr">--</span><span class="hr-unit">bpm</span>
    <div class="hr-zone" id="zone">waiting for data</div>
  </div>

  <div class="window-bar" id="windowBar">
    window: <span id="windowTitle">--</span>
  </div>

  <div class="chart-wrap">
    <canvas id="chart" height="140"></canvas>
  </div>

  <div class="stats">
    <div class="stat-box">
      <div class="stat-label">avg</div>
      <div class="stat-val" id="avg">--</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">max</div>
      <div class="stat-val" id="max">--</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">min</div>
      <div class="stat-val" id="min">--</div>
    </div>
  </div>

  <div class="chat-section">
    <div class="chat-messages" id="chatMessages">
      <div class="chat-empty">
        <div class="chat-empty-hint">é—®ç‚¹ä»€ä¹ˆå§ ğŸ’¬</div>
        <div class="chat-quick-btns">
          <button class="chat-quick-btn" data-q="ä»–è¿˜æ´»ç€å—ï¼Ÿ">ä»–è¿˜æ´»ç€å—ï¼Ÿ</button>
          <button class="chat-quick-btn" data-q="ä»€ä¹ˆæ—¶å€™å¿ƒç‡é«˜ï¼Ÿ">ä»€ä¹ˆæ—¶å€™å¿ƒç‡é«˜ï¼Ÿ</button>
          <button class="chat-quick-btn" data-q="ä»–QQç”¨äº†å¤šä¹…">ä»–QQç”¨äº†å¤šä¹…ï¼Ÿ</button>
          <button class="chat-quick-btn" data-q="å¿ƒç‡æ€ä¹ˆæ ·ï¼Ÿ">å¿ƒç‡æ€ä¹ˆæ ·ï¼Ÿ</button>
          <button class="chat-quick-btn" data-q="åœ¨æ‘¸é±¼å—ï¼Ÿ">åœ¨æ‘¸é±¼å—ï¼Ÿ</button>
        </div>
      </div>
    </div>
    <div class="chat-input-row">
      <input type="text" id="chatInput" placeholder="é—®é—® AI åŠ©æ‰‹ï¼šä»–åœ¨å¹²ä»€ä¹ˆï¼Ÿå¿ƒç‡æ€ä¹ˆæ ·ï¼Ÿ" />
      <button id="chatSend" onclick="sendChat()">å‘é€</button>
    </div>
  </div>

  <div class="footer">ranjyaa-miband Â· sse Â· langchain agent</div>
</div>

<script>
const MAX_PTS = 25;
const data = [];
let hrMin = Infinity, hrMax = -Infinity, hrSum = 0, hrCount = 0;
const $ = id => document.getElementById(id);

/* ---- SSE ---- */
const es = new EventSource('/stream');
es.onopen = () => {
  $('dot').classList.add('live');
  $('status').textContent = 'connected';
};
es.onerror = () => {
  $('dot').classList.remove('live');
  $('status').textContent = 'reconnecting...';
};
es.onmessage = e => {
  const d = JSON.parse(e.data);
  const hr = d.heart_rate;
  if (!hr) return;

  /* æ—¶é—´æ ‡ç­¾ */
  const now = new Date();
  const timeStr = now.toTimeString().slice(0,8);

  data.push({ hr, time: timeStr });
  if (data.length > MAX_PTS) data.shift();

  /* ç»Ÿè®¡ */
  hrCount++; hrSum += hr;
  if (hr > hrMax) hrMax = hr;
  if (hr < hrMin) hrMin = hr;
  $('avg').textContent = Math.round(hrSum / hrCount);
  $('max').textContent = hrMax;
  $('min').textContent = hrMin;

  /* å¿ƒç‡å€¼ */
  const el = $('hr');
  el.textContent = hr;
  el.style.color = hr > 120 ? 'var(--red)' : hr > 100 ? 'var(--yellow)' : 'var(--green)';
  el.classList.add('bump');
  setTimeout(() => el.classList.remove('bump'), 150);

  /* åŒºé—´ */
  let zone = 'resting';
  if (hr > 140) zone = 'high intensity';
  else if (hr > 120) zone = 'cardio';
  else if (hr > 100) zone = 'warm up';
  $('zone').textContent = zone;

  /* å½“å‰çª—å£ */
  if (d.current_window) {
    $('windowTitle').textContent = d.current_window;
  }

  drawChart();
};

/* ---- Chart ---- */
function drawChart() {
  const c = $('chart');
  const dpr = window.devicePixelRatio || 1;
  const rect = c.getBoundingClientRect();
  c.width = rect.width * dpr;
  c.height = rect.height * dpr;
  const ctx = c.getContext('2d');
  ctx.scale(dpr, dpr);
  const W = rect.width, H = rect.height;

  const pad = { top: 12, right: 12, bottom: 32, left: 38 };
  const gw = W - pad.left - pad.right;
  const gh = H - pad.top - pad.bottom;

  ctx.clearRect(0, 0, W, H);
  if (data.length < 2) return;

  const hrs = data.map(d => d.hr);
  const lo = Math.min(...hrs) - 5;
  const hi = Math.max(...hrs) + 5;
  const range = hi - lo || 1;

  const pts = data.map((d, i) => ({
    x: pad.left + (i / (data.length - 1)) * gw,
    y: pad.top + (1 - (d.hr - lo) / range) * gh
  }));

  /* æ¸å˜å¡«å…… */
  const grad = ctx.createLinearGradient(0, pad.top, 0, pad.top + gh);
  grad.addColorStop(0, 'rgba(239,68,68,.25)');
  grad.addColorStop(1, 'rgba(239,68,68,0)');
  ctx.beginPath();
  ctx.moveTo(pts[0].x, pad.top + gh);
  pts.forEach(p => ctx.lineTo(p.x, p.y));
  ctx.lineTo(pts[pts.length - 1].x, pad.top + gh);
  ctx.closePath();
  ctx.fillStyle = grad;
  ctx.fill();

  /* çº¿ */
  ctx.beginPath();
  pts.forEach((p, i) => i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y));
  ctx.strokeStyle = 'var(--red)';
  ctx.lineWidth = 2;
  ctx.stroke();

  /* æœ«ç«¯åœ†ç‚¹ */
  const last = pts[pts.length - 1];
  ctx.beginPath();
  ctx.arc(last.x, last.y, 4, 0, Math.PI * 2);
  ctx.fillStyle = '#ef4444';
  ctx.fill();

  /* Y è½´åˆ»åº¦ */
  ctx.fillStyle = '#71717a';
  ctx.font = '11px Courier New';
  ctx.textAlign = 'right';
  for (let i = 0; i <= 4; i++) {
    const val = Math.round(lo + (range * i) / 4);
    const y = pad.top + gh - (gh * i) / 4;
    ctx.fillText(val, pad.left - 6, y + 4);
  }

  /* X è½´æ—¶é—´æ ‡ç­¾ â€” æ ¹æ®å®½åº¦è‡ªåŠ¨å‡å°‘ */
  ctx.textAlign = 'center';
  ctx.fillStyle = '#71717a';
  ctx.font = '10px Courier New';
  const labelWidth = 70;
  const maxLabels = Math.max(2, Math.floor(gw / labelWidth));
  const labelCount = Math.min(data.length, maxLabels);
  const step = Math.max(1, Math.floor((data.length - 1) / (labelCount - 1)));
  for (let i = 0; i < data.length; i += step) {
    const x = pad.left + (i / (data.length - 1)) * gw;
    ctx.fillText(data[i].time, x, H - pad.bottom + 16);
  }
  /* æœ«å°¾æ ‡ç­¾ */
  if ((data.length - 1) % step !== 0) {
    ctx.fillText(data[data.length - 1].time, pts[pts.length - 1].x, H - pad.bottom + 16);
  }
}

/* ---- Chat ---- */
let chatBusy = false;

async function sendChat() {
  const input = $('chatInput');
  const msg = input.value.trim();
  if (!msg || chatBusy) return;

  chatBusy = true;
  $('chatSend').disabled = true;
  input.value = '';

  /* é¦–æ¬¡å‘é€æ—¶ï¼Œå°†è¾“å…¥æ¡†ç§»åˆ°åº•éƒ¨ */
  const chatSection = input.closest('.chat-section');
  if (!chatSection.classList.contains('has-messages')) {
    chatSection.classList.add('has-messages');
  }

  const messages = $('chatMessages');

  /* ç”¨æˆ·æ°”æ³¡ */
  const userBubble = document.createElement('div');
  userBubble.className = 'msg-user';
  userBubble.textContent = msg;
  messages.appendChild(userBubble);

  /* agent æ¶ˆæ¯ç»„å®¹å™¨ */
  const agentGroup = document.createElement('div');
  agentGroup.className = 'msg-agent-group';
  messages.appendChild(agentGroup);

  /* loading */
  const loadingEl = document.createElement('div');
  loadingEl.className = 'msg-loading';
  loadingEl.textContent = 'thinking';
  agentGroup.appendChild(loadingEl);

  messages.scrollTop = messages.scrollHeight;

  /* çŠ¶æ€è¿½è¸ª */
  let thinkingDetails = null; /* <details> å…ƒç´  */
  let thinkingContent = null; /* æ€ç»´é“¾å†…å®¹å®¹å™¨ */
  let thinkingText = '';
  let toolDetails = null;     /* å½“å‰å·¥å…·è°ƒç”¨çš„ <details> */
  let answerEl = null;         /* æœ€ç»ˆå›ç­”æ°”æ³¡ */
  let inThink = false;         /* æ˜¯å¦åœ¨ <think> æ ‡ç­¾å†… */
  let answerText = '';

  try {
    const resp = await fetch('/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: msg })
    });

    const reader = resp.body.getReader();
    const decoder = new TextDecoder();
    let buf = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buf += decoder.decode(value, { stream: true });

      const lines = buf.split('\n');
      buf = lines.pop();

      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        const raw = line.slice(6).trim();
        if (!raw) continue;

        let evt;
        try { evt = JSON.parse(raw); } catch { continue; }

        /* ç§»é™¤ loading */
        if (loadingEl.parentNode) loadingEl.remove();

        if (evt.type === 'thinking') {
          /* å·¥å…·è°ƒç”¨æ€ç»´ â†’ å±•ç¤ºåœ¨æ€ç»´é“¾æ°”æ³¡ä¸­ */
          if (!thinkingDetails) {
            thinkingDetails = document.createElement('details');
            thinkingDetails.className = 'msg-thinking';
            thinkingDetails.open = true;
            const summary = document.createElement('summary');
            summary.textContent = 'ğŸ’­ æ€ç»´è¿‡ç¨‹';
            thinkingDetails.appendChild(summary);
            const body = document.createElement('div');
            body.className = 'details-body';
            const inner = document.createElement('div');
            inner.className = 'details-inner';
            thinkingContent = document.createElement('div');
            thinkingContent.className = 'thinking-content';
            inner.appendChild(thinkingContent);
            body.appendChild(inner);
            thinkingDetails.appendChild(body);
            agentGroup.appendChild(thinkingDetails);
          }
          thinkingText += evt.content;
          thinkingContent.textContent = thinkingText;
          messages.scrollTop = messages.scrollHeight;

        } else if (evt.type === 'tool_result') {
          /* å·¥å…·è°ƒç”¨ç»“æœ â†’ åµŒå…¥æ€ç»´é“¾æ°”æ³¡å†…éƒ¨ */
          if (!thinkingDetails) {
            thinkingDetails = document.createElement('details');
            thinkingDetails.className = 'msg-thinking';
            thinkingDetails.open = true;
            const s = document.createElement('summary');
            s.textContent = 'ğŸ’­ æ€ç»´è¿‡ç¨‹';
            thinkingDetails.appendChild(s);
            const body = document.createElement('div');
            body.className = 'details-body';
            const inner = document.createElement('div');
            inner.className = 'details-inner';
            thinkingContent = document.createElement('div');
            thinkingContent.className = 'thinking-content';
            inner.appendChild(thinkingContent);
            body.appendChild(inner);
            thinkingDetails.appendChild(body);
            agentGroup.appendChild(thinkingDetails);
          }
          toolDetails = document.createElement('details');
          toolDetails.className = 'msg-tool';
          const summary = document.createElement('summary');
          summary.textContent = 'ğŸ”§ ' + (evt.name || 'tool');
          toolDetails.appendChild(summary);
          const tBody = document.createElement('div');
          tBody.className = 'details-body';
          const tInner = document.createElement('div');
          tInner.className = 'details-inner';
          const content = document.createElement('div');
          content.className = 'tool-content';
          /* å°è¯•æ ¼å¼åŒ– JSON */
          try {
            const parsed = JSON.parse(evt.content);
            content.textContent = JSON.stringify(parsed, null, 2);
          } catch {
            content.textContent = evt.content || '(no output)';
          }
          tInner.appendChild(content);
          tBody.appendChild(tInner);
          toolDetails.appendChild(tBody);
          thinkingDetails.querySelector('.details-inner').appendChild(toolDetails);
          messages.scrollTop = messages.scrollHeight;

        } else if (evt.type === 'answer') {
          let text = evt.content || '';

          /* å¤„ç† <think> æ ‡ç­¾ï¼šæå–æ€ç»´é“¾å†…å®¹ */
          while (text.length > 0) {
            if (inThink) {
              const closeIdx = text.indexOf('</think>');
              if (closeIdx !== -1) {
                /* ç»“æŸ think */
                const thinkPart = text.slice(0, closeIdx);
                thinkingText += thinkPart;
                if (thinkingContent) thinkingContent.textContent = thinkingText;
                text = text.slice(closeIdx + 8);
                inThink = false;
              } else {
                /* è¿˜æ²¡ç»“æŸï¼Œå…¨éƒ¨æ˜¯æ€ç»´å†…å®¹ */
                thinkingText += text;
                if (thinkingContent) thinkingContent.textContent = thinkingText;
                text = '';
              }
            } else {
              const openIdx = text.indexOf('<think>');
              if (openIdx !== -1) {
                /* è¿›å…¥ think */
                const before = text.slice(0, openIdx);
                if (before) {
                  if (!answerEl) {
                    answerEl = document.createElement('div');
                    answerEl.className = 'msg-answer';
                    agentGroup.appendChild(answerEl);
                  }
                  answerText += before;
                  answerEl.textContent = answerText.trimStart();
                }
                text = text.slice(openIdx + 7);
                inThink = true;
                /* ç¡®ä¿æ€ç»´é“¾æ°”æ³¡å­˜åœ¨ */
                if (!thinkingDetails) {
                  thinkingDetails = document.createElement('details');
                  thinkingDetails.className = 'msg-thinking';
                  thinkingDetails.open = true;
                  const summary = document.createElement('summary');
                  summary.textContent = 'ğŸ’­ æ€ç»´è¿‡ç¨‹';
                  thinkingDetails.appendChild(summary);
                  const body = document.createElement('div');
                  body.className = 'details-body';
                  const inner = document.createElement('div');
                  inner.className = 'details-inner';
                  thinkingContent = document.createElement('div');
                  thinkingContent.className = 'thinking-content';
                  inner.appendChild(thinkingContent);
                  body.appendChild(inner);
                  thinkingDetails.appendChild(body);
                  /* æ’åˆ° answerEl å‰é¢ */
                  if (answerEl && answerEl.parentNode) {
                    agentGroup.insertBefore(thinkingDetails, answerEl);
                  } else {
                    agentGroup.appendChild(thinkingDetails);
                  }
                }
              } else {
                /* æ­£å¸¸å›ç­”å†…å®¹ */
                if (!answerEl) {
                  answerEl = document.createElement('div');
                  answerEl.className = 'msg-answer';
                  agentGroup.appendChild(answerEl);
                }
                answerText += text;
                answerEl.textContent = answerText.trimStart();
                text = '';
              }
            }
          }
          messages.scrollTop = messages.scrollHeight;

        } else if (evt.type === 'done') {
          /* å®Œæˆ â€” æ¸…ç†ç©ºæ°”æ³¡ï¼Œæ¸²æŸ“markdown */
          if (thinkingDetails && !thinkingText.trim()) {
            thinkingDetails.remove();
          }
          if (answerEl) {
            const trimmed = answerText.trimStart();
            if (!trimmed) {
              answerEl.remove();
            } else {
              /* ç”¨ marked æ¸²æŸ“ markdown */
              try {
                answerEl.innerHTML = marked.parse(trimmed);
              } catch {
                answerEl.textContent = trimmed;
              }
            }
          }
          /* å¦‚æœä»€ä¹ˆéƒ½æ²¡è¾“å‡º */
          if (!agentGroup.children.length) {
            const empty = document.createElement('div');
            empty.className = 'msg-answer';
            empty.textContent = '(æ— å›å¤)';
            agentGroup.appendChild(empty);
          }
        }
      }
    }
  } catch (err) {
    if (loadingEl.parentNode) loadingEl.remove();
    const errEl = document.createElement('div');
    errEl.className = 'msg-answer';
    errEl.style.color = 'var(--red)';
    errEl.textContent = 'è¯·æ±‚å¤±è´¥: ' + err.message;
    agentGroup.appendChild(errEl);
  }

  chatBusy = false;
  $('chatSend').disabled = false;
  messages.scrollTop = messages.scrollHeight;
}

/* Enter å‘é€ */
$('chatInput').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendChat();
  }
});

/* å¿«æ·é—®é¢˜æŒ‰é’® */
document.querySelectorAll('.chat-quick-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    $('chatInput').value = btn.dataset.q;
    sendChat();
  });
});
</script>
</body>
</html>